<!DOCTYPE html>
<html>
<head>
  <title>Registrar Entrega v2.5</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 700px; }
    .loader { 
      border: 8px solid #f3f3f3; 
      border-radius: 50%; 
      border-top: 8px solid #3498db; 
      width: 50px; 
      height: 50px; 
      animation: spin 1s linear infinite; 
      display: none; 
      margin: 20px auto; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    #formulario-entrega { display: none; }
    .match-card {
      border: 1px solid #ddd;
      margin: 10px 0;
      padding: 15px;
      border-radius: 5px;
      background: #fff;
    }
    .match-deliverable { border-left: 5px solid #28a745; }
    .match-not-deliverable { border-left: 5px solid #dc3545; }
    .match-already-delivered { border-left: 5px solid #ffc107; }
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 10px;
      margin: 10px 0;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4>Buscar Pedido para Entrega v2.5</h4>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="numero-pedido"><b>N√∫mero de Pedido / NV</b></label>
          <input type="text" class="form-control form-control-lg" id="numero-pedido" placeholder="Ej: 25200, NV123, etc...">
          <small class="form-text text-muted">Busca en columna K (N√∫mero de Pedido) y columna B (N√∫mero de NV)</small>
        </div>
        <button id="btn-buscar" class="btn btn-primary btn-block btn-lg">üîç Buscar Pedido</button>
        <div class="mt-2">
          <input type="checkbox" id="debug-mode"> <label for="debug-mode">Modo Debug (mostrar informaci√≥n t√©cnica)</label>
        </div>
      </div>
    </div>

    <div id="loader" class="loader"></div>
    <div id="resultado-busqueda" class="mt-3"></div>

    <div id="formulario-entrega" class="card mt-4">
      <div class="card-header bg-success text-white">
        <h5>Registrar Entrega</h5>
      </div>
      <div class="card-body">
        <div id="info-pedido-seleccionado"></div>
        <hr>
        <input type="hidden" id="sheetRow">
        <input type="hidden" id="pedidoOrigen">
        <input type="hidden" id="pedidoNumero">
        
        <div class="form-group">
          <label for="entregado-por"><b>Entregado por:</b></label>
          <input type="text" class="form-control" id="entregado-por" required placeholder="Nombre de quien entrega">
        </div>
        
        <div class="form-group">
          <label for="recibido-por"><b>Recibido por (Nombre y RUT):</b></label>
          <input type="text" class="form-control" id="recibido-por" required placeholder="Ej: Juan P√©rez - 12.345.678-9">
        </div>
        
        <div class="form-group">
          <label><b>Fotos de Entrega (M√≠nimo 1, M√°ximo 3):</b></label>
          <input type="file" class="form-control-file mb-2" id="foto1" accept="image/*" required>
          <small class="form-text text-muted">Foto 1 (Obligatoria)</small>
          <input type="file" class="form-control-file mb-2" id="foto2" accept="image/*">
          <small class="form-text text-muted">Foto 2 (Opcional)</small>
          <input type="file" class="form-control-file" id="foto3" accept="image/*">
          <small class="form-text text-muted">Foto 3 (Opcional)</small>
        </div>
        
        <button id="btn-guardar" class="btn btn-success btn-block btn-lg">üíæ Guardar Entrega</button>
        <button id="btn-cancelar" class="btn btn-secondary btn-block" type="button">Cancelar</button>
      </div>
    </div>
  </div>

<script>
  // IMPORTANTE: Debes actualizar esta URL con la de tu Apps Script desplegado
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwI95jnKF9gMeMDtHDtBKi3m9Y0W66u6sSzL1b-FBUYZ-vl80sNVzMy0G2up3wC3d4_Ng/exec";

  let currentMatches = [];

  document.getElementById('btn-buscar').addEventListener('click', buscarPedido);
  document.getElementById('btn-guardar').addEventListener('click', guardarEntrega);
  document.getElementById('btn-cancelar').addEventListener('click', cancelarEntrega);
  
  // Permitir buscar con Enter
  document.getElementById('numero-pedido').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      buscarPedido();
    }
  });

  function mostrarLoader(mostrar) {
    document.getElementById('loader').style.display = mostrar ? 'block' : 'none';
  }

  function mostrarAlerta(mensaje, tipo = 'danger') {
    const container = document.getElementById('resultado-busqueda');
    container.innerHTML = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
      ${mensaje}
      <button type="button" class="close" data-dismiss="alert">
        <span>&times;</span>
      </button>
    </div>`;
  }

  function mostrarDebug(info) {
    if (document.getElementById('debug-mode').checked) {
      const container = document.getElementById('resultado-busqueda');
      container.innerHTML += `<div class="debug-info"><strong>Debug:</strong><br>${JSON.stringify(info, null, 2)}</div>`;
    }
  }

  function buscarPedido() {
    const numeroPedido = document.getElementById('numero-pedido').value.trim();
    if (!numeroPedido) {
      mostrarAlerta('Por favor, ingrese un n√∫mero de pedido.', 'warning');
      return;
    }

    mostrarLoader(true);
    document.getElementById('btn-buscar').disabled = true;
    document.getElementById('resultado-busqueda').innerHTML = '';
    document.getElementById('formulario-entrega').style.display = 'none';
    currentMatches = [];

    console.log('Buscando pedido:', numeroPedido);

    fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8'
      },
      body: JSON.stringify({
        action: 'buscarPedido',
        payload: { numeroPedido: numeroPedido }
      })
    })
    .then(response => {
      console.log('Respuesta del servidor:', response);
      return response.json();
    })
    .then(data => {
      console.log('Datos recibidos:', data);
      mostrarDebug(data);
      procesarResultadoBusqueda(data);
    })
    .catch(error => {
      console.error('Error en b√∫squeda:', error);
      mostrarLoader(false);
      document.getElementById('btn-buscar').disabled = false;
      mostrarAlerta(`Error de comunicaci√≥n: ${error.message}`, 'danger');
    });
  }

  function procesarResultadoBusqueda(response) {
    mostrarLoader(false);
    document.getElementById('btn-buscar').disabled = false;

    if (response.success && response.data) {
      // Respuesta exitosa con un pedido encontrado
      mostrarFormularioEntrega(response.data);
    } else {
      // No se encontraron resultados o hubo error
      mostrarAlerta(response.message || 'No se encontraron resultados', 'warning');
    }
  }

  function mostrarFormularioEntrega(data) {
    // Llenar informaci√≥n del pedido
    document.getElementById('info-pedido-seleccionado').innerHTML = `
      <div class="row">
        <div class="col-md-6"><strong>Pedido:</strong> ${data.numeroPedido}</div>
        <div class="col-md-6"><strong>Origen:</strong> ${data.origen}</div>
      </div>
      <div class="row mt-2">
        <div class="col-md-6"><strong>Cliente:</strong> ${data.cliente}</div>
        <div class="col-md-6"><strong>Armado por:</strong> ${data.armadoPor}</div>
      </div>
      <div class="row mt-2">
        <div class="col-12"><strong>Fila en hoja:</strong> ${data.sheetRow}</div>
      </div>
      ${data.deliverabilityMessage ? `<div class="alert alert-info mt-2">${data.deliverabilityMessage}</div>` : ''}
    `;

    // Llenar campos ocultos
    document.getElementById('sheetRow').value = data.sheetRow;
    document.getElementById('pedidoOrigen').value = data.origen;
    document.getElementById('pedidoNumero').value = data.numeroPedido;

    // Mostrar formulario
    document.getElementById('formulario-entrega').style.display = 'block';
    
    // Mostrar mensaje de √©xito
    mostrarAlerta('Pedido encontrado. Complete los datos de entrega.', 'success');
  }

  function cancelarEntrega() {
    document.getElementById('formulario-entrega').style.display = 'none';
    document.getElementById('numero-pedido').value = '';
    document.getElementById('resultado-busqueda').innerHTML = '';
    
    // Limpiar formulario
    document.getElementById('entregado-por').value = '';
    document.getElementById('recibido-por').value = '';
    document.getElementById('foto1').value = '';
    document.getElementById('foto2').value = '';
    document.getElementById('foto3').value = '';
  }

  async function guardarEntrega() {
    const entregadoPor = document.getElementById('entregado-por').value.trim();
    const recibidoPor = document.getElementById('recibido-por').value.trim();
    const foto1 = document.getElementById('foto1');

    if (!entregadoPor || !recibidoPor || foto1.files.length === 0) {
      mostrarAlerta('Debe completar todos los campos obligatorios y seleccionar al menos la Foto 1.', 'danger');
      return;
    }

    mostrarLoader(true);
    document.getElementById('btn-guardar').disabled = true;
    mostrarAlerta('Guardando entrega, por favor espere...', 'info');

    try {
      // Procesar archivos de fotos
      const fotosPromesas = [
        document.getElementById('foto1'),
        document.getElementById('foto2'),
        document.getElementById('foto3')
      ].map(input => procesarArchivo(input));

      const fotosBase64 = await Promise.all(fotosPromesas);
      const fotosValidas = fotosBase64.filter(f => f !== null);

      console.log(`Procesadas ${fotosValidas.length} fotos`);

      const deliveryData = {
        sheetRow: parseInt(document.getElementById('sheetRow').value),
        numeroPedido: document.getElementById('pedidoNumero').value,
        origen: document.getElementById('pedidoOrigen').value,
        entregadoPor: entregadoPor,
        recibidoPor: recibidoPor,
        fotos: fotosValidas
      };

      console.log('Enviando datos de entrega:', deliveryData);
      mostrarDebug(deliveryData);

      fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain;charset=utf-8'
        },
        body: JSON.stringify({
          action: 'registrarEntrega',
          payload: deliveryData
        })
      })
      .then(response => response.json())
      .then(response => {
        console.log('Respuesta de entrega:', response);
        mostrarDebug(response);
        procesarResultadoEntrega(response);
      })
      .catch(error => {
        console.error('Error guardando entrega:', error);
        mostrarLoader(false);
        document.getElementById('btn-guardar').disabled = false;
        mostrarAlerta(`Error guardando entrega: ${error.message}`, 'danger');
      });

    } catch (error) {
      console.error('Error procesando fotos:', error);
      mostrarLoader(false);
      document.getElementById('btn-guardar').disabled = false;
      mostrarAlerta(`Error procesando archivos: ${error.message}`, 'danger');
    }
  }

  function procesarArchivo(fileInput) {
    return new Promise((resolve, reject) => {
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = (e) => {
          const base64Data = e.target.result.split(',')[1];
          resolve({
            base64Data: base64Data,
            mimeType: file.type,
            fileName: file.name
          });
        };
        
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      } else {
        resolve(null);
      }
    });
  }

  function procesarResultadoEntrega(response) {
    mostrarLoader(false);
    document.getElementById('btn-guardar').disabled = false;

    if (response.success) {
      mostrarAlerta(response.message, 'success');
      // Limpiar y ocultar formulario
      setTimeout(() => {
        cancelarEntrega();
      }, 2000);
    } else {
      mostrarAlerta(response.message || 'Error desconocido al guardar entrega', 'danger');
    }
  }
</script>

<!-- Bootstrap JS para funcionalidades adicionales -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
